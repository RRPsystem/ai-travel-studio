<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        #website-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p>Loading website...</p>
    </div>
    <iframe id="website-frame" style="display:none;"></iframe>
    <script>
        const SUPABASE_URL = 'https://huaaogdxxdcakxryecnw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1YWFvZ2R4eGRjYWt4cnllY253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MDY2OTAsImV4cCI6MjA3OTI2NjY5MH0.ygqwQNOpbJqe9NHtlxLCIlmVk2j5Mkcw4qvMpkGyeY0';

        (async function() {
            try {
                const hostname = window.location.hostname;
                const subdomain = hostname.replace('.ai-travelstudio.nl', '');
                const path = window.location.pathname === '/subdomain.html' ? '/' : window.location.pathname;
                const slug = path === '/' ? '/' : path;

                console.log('Loading subdomain:', subdomain, 'slug:', slug);

                const domainResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/brand_domains?select=website_id&subdomain_prefix=eq.${encodeURIComponent(subdomain)}`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!domainResponse.ok) {
                    throw new Error('Domain lookup failed: ' + domainResponse.status);
                }

                const domains = await domainResponse.json();
                console.log('Domains found:', domains);

                if (!domains || domains.length === 0) {
                    document.getElementById('loading').innerHTML = '<h1>Website not found</h1>';
                    return;
                }

                const websiteId = domains[0].website_id;
                console.log('Website ID:', websiteId);

                const pageResponse = await fetch(
                    `${SUPABASE_URL}/rest/v1/pages?select=body_html,title&website_id=eq.${encodeURIComponent(websiteId)}&slug=eq.${encodeURIComponent(slug)}`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!pageResponse.ok) {
                    throw new Error('Page lookup failed: ' + pageResponse.status);
                }

                const pages = await pageResponse.json();
                console.log('Pages found:', pages.length);

                if (!pages || pages.length === 0) {
                    document.getElementById('loading').innerHTML = '<h1>Page not found for slug: ' + slug + '</h1>';
                    return;
                }

                let html = pages[0].body_html;

                const cspMeta = '<meta http-equiv="Content-Security-Policy" content="default-src * \'unsafe-inline\' \'unsafe-eval\' data: blob:; script-src * \'unsafe-inline\' \'unsafe-eval\'; style-src * \'unsafe-inline\'; img-src * data: blob:; font-src * data:; connect-src *;">';

                if (html.includes('<head>')) {
                    html = html.replace('<head>', '<head>' + cspMeta);
                } else if (html.includes('<HEAD>')) {
                    html = html.replace('<HEAD>', '<HEAD>' + cspMeta);
                }

                const iframe = document.getElementById('website-frame');
                iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox allow-downloads allow-modals allow-orientation-lock allow-pointer-lock allow-presentation allow-top-navigation-by-user-activation');
                iframe.srcdoc = html;

                iframe.onload = function() {
                    document.getElementById('loading').style.display = 'none';
                    iframe.style.display = 'block';
                };

            } catch (error) {
                console.error('Error loading website:', error);
                document.getElementById('loading').innerHTML = '<h1>Error loading website: ' + error.message + '</h1>';
            }
        })();
    </script>
</body>
</html>
